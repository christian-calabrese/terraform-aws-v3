name: Split and Push Changes

on:
  push:
    branches:
      - main

jobs:
  split_and_push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
            fetch-depth: 2 # Ensure we have enough history for the diff

      - name: Get modified modules
        id: get-modules
        run: |
          files=$(git diff-tree --no-commit-id --name-only -r ${{ github.sha }})
          folders_list="[]"

          for file in $files; do
            if [[ $file == modules/* ]]; then
              folder=$(echo "$file" | sed -E 's|^modules/([^/]+)/.*|\1|')
              folders_list=$(echo "$folders_list" | jq ". += [\"$folder\"]")
            fi
          done

          unique_list=$(echo "$folders_list" | jq -c 'unique')
          echo "unique_list=$unique_list" >> $GITHUB_ENV
          echo "::set-output name=modules::$unique_list"
      
      - name: Process each module
        run: |
          modified_modules="${{ steps.get-modules.outputs.modules }}"
          modules=$(echo "$modified_modules" | jq -c '.[]')
          if [ -z "$modules" ]; then
            echo "No modules to process."
            exit 0
          fi

          for module in $modules; do
            echo "Processing module: $module"
            REPO_URL="https://github.com/christian-calabrese/terraform-aws-$module.git"
            MODULE_PATH="modules/$module"
            git subtree push --prefix=$MODULE_PATH $REPO_URL main
          done
        shell: /usr/bin/bash -e {0}